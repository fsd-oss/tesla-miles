<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#111111">
    <title>FSD Milestone Tracker</title>
    <style>
        :root { --red: #E82127; --bg: #111; --card: #1d1d1d; --text: #fff; --dim: #a0a0a0; --border: #333; }
        [data-theme="light"] { --bg: #f4f4f4; --card: #fff; --text: #111; --dim: #666; --border: #ddd; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; transition: background 0.3s; }
        .container { background: var(--card); padding: 25px; border-radius: 16px; width: 100%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--red); margin-bottom: 20px; padding-bottom: 10px; }
        h1 { font-size: 1rem; text-transform: uppercase; letter-spacing: 2px; margin: 0; }
        .btn { width: 100%; padding: 16px; background: var(--red); color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 10px; font-size: 1rem; }
        .btn-sec { background: transparent; border: 1px solid var(--border); color: var(--text); padding: 8px; font-size: 0.75rem; border-radius: 4px; }
        .stat-box { display: flex; justify-content: space-between; margin-bottom: 20px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: rgba(0,0,0,0.2); }
        .stat-item { text-align: center; flex: 1; }
        .stat-label { font-size: 0.7rem; color: var(--dim); text-transform: uppercase; }
        .stat-value { display: block; font-size: 1.4rem; font-weight: bold; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: var(--dim); font-size: 0.8rem; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: var(--text); font-size: 1.1rem; box-sizing: border-box; }
        .highlight { background: rgba(232, 33, 39, 0.05); padding: 25px; border-radius: 12px; text-align: center; margin-top: 5px; border: 1px solid rgba(232, 33, 39, 0.2); }
        .big-number { display: block; font-size: 4rem; font-weight: 900; color: var(--red); line-height: 1; margin: 10px 0; }
        .history-section { margin-top: 30px; border-top: 1px solid var(--border); padding-top: 15px; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; color: var(--text); }
        .history-table th { text-align: left; color: var(--dim); padding: 8px; border-bottom: 1px solid var(--border); }
        .history-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        #status { font-size: 0.85rem; text-align: center; display: block; margin-bottom: 15px; color: #4CAF50; font-weight: bold; min-height: 1.2em; }
        summary { font-size: 0.75rem; color: var(--dim); cursor: pointer; text-align: center; margin-top: 20px; }
    </style>
</head>
<body data-theme="dark">
<div class="container">
    <div class="header">
        <h1>FSD Optimizer</h1>
        <button onclick="toggleTheme()" class="btn-sec">üåì Theme</button>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
        <button class="btn" onclick="document.getElementById('cameraTrigger').click()">üì∑ Camera</button>
        <button class="btn" onclick="document.getElementById('fileTrigger').click()">üñºÔ∏è Gallery</button>
    </div>
    
    <input type="file" id="cameraTrigger" accept="image/*" capture="environment" style="display:none" onchange="handleScan(event)">
    <input type="file" id="fileTrigger" accept="image/*" style="display:none" onchange="handleScan(event)">
    
    <span id="status">System Ready</span>

    <div class="stat-box">
        <div class="stat-item"><span class="stat-label">Current %</span><span class="stat-value" id="disp_pct">--%</span></div>
        <div class="stat-item" style="border-left:1px solid var(--border);"><span class="stat-label">Next Target</span><span class="stat-value" id="disp_next">--%</span></div>
    </div>

    <div class="input-group">
        <label>Self-Driving Miles</label>
        <input type="number" id="sd_miles" step="0.1" inputmode="decimal" oninput="saveAndCalc(true)">
    </div>
    <div class="input-group">
        <label>Total Miles</label>
        <input type="number" id="total_miles" step="0.1" inputmode="decimal" oninput="saveAndCalc(true)">
    </div>

    <div class="highlight">
        <span style="font-size: 0.9rem; color: var(--dim);" id="milestone_desc">Miles to next %</span>
        <span class="big-number" id="result">--</span>
    </div>

    <div class="history-section">
        <h3 style="font-size: 0.8rem; text-transform: uppercase;">History</h3>
        <table class="history-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>FSD Miles</th>
                    <th>Total Miles</th>
                    <th style="color: var(--red);">Target Gap</th>
                </tr>
            </thead>
            <tbody id="history_body"></tbody>
        </table>
    </div>
        
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
        <button class="btn btn-sec" onclick="exportData()">üì§ Export Data</button>
        <button class="btn btn-sec" onclick="document.getElementById('impInput').click()">üì• Import Data</button>
        <input type="file" id="impInput" accept=".json" style="display:none" onchange="importData(event)">
    </div>

    <details>
        <summary>API Settings & Migration</summary>
        <div class="input-group" style="margin-top:15px;">
            <label>Gemini API Key</label>
            <input type="password" id="api_key" placeholder="AIza..." oninput="localStorage.setItem('tsla_key', this.value)">
        </div>
        <button class="btn btn-sec" style="width:100%;" onclick="attemptMigration()">üîç Try Recovering Old Data</button>
        <div id="debug" style="font-family:monospace; font-size:0.6rem; color:#666; background:#000; padding:10px; border-radius:5px; margin-top:10px; max-height:100px; overflow-y:auto; white-space:pre-wrap; text-align:left;">--- Logs ---</div>
    </details>
</div>

<script>
    const MODEL_ID = "gemini-2.5-flash"; 
    const sdIn = document.getElementById('sd_miles');
    const totIn = document.getElementById('total_miles');

    function log(msg) { document.getElementById('debug').innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}\n` + document.getElementById('debug').innerHTML; }

    window.onload = () => {
        sdIn.value = localStorage.getItem('tsla_sd') || localStorage.getItem('tesla_sd_miles') || "";
        totIn.value = localStorage.getItem('tsla_tot') || localStorage.getItem('tesla_total_miles') || "";
        document.getElementById('api_key').value = localStorage.getItem('tsla_key') || localStorage.getItem('tsla_gemini_key') || "";
        const savedTheme = localStorage.getItem('tsla_theme') || "dark";
        document.body.setAttribute('data-theme', savedTheme);
        calculate();
        renderHistory();
        log("Origin data loaded.");
    };

    function attemptMigration() {
        const keys = ['tesla_sd_miles', 'tesla_total_miles', 'tsla_sd', 'tsla_tot', 'tsla_key', 'tsla_gemini_key'];
        let foundCount = 0;
        keys.forEach(k => {
            if(localStorage.getItem(k)) {
                log(`Found legacy key: ${k}`);
                foundCount++;
            }
        });
        if(foundCount > 0) {
            log("Migration attempt finished. Refreshing...");
            setTimeout(() => location.reload(), 1500);
        } else {
            log("No legacy keys found.");
        }
    }

    function saveAndCalc(addHistory = false) {
        localStorage.setItem('tsla_sd', sdIn.value);
        localStorage.setItem('tsla_tot', totIn.value);
        if (addHistory && sdIn.value && totIn.value) {
            let hist = JSON.parse(localStorage.getItem('tsla_history') || "[]");
            if (hist.length === 0 || hist[0].sd !== sdIn.value || hist[0].tot !== totIn.value) {
                hist.unshift({ sd: sdIn.value, tot: totIn.value, time: new Date().toLocaleString() });
                localStorage.setItem('tsla_history', JSON.stringify(hist.slice(0, 50)));
                renderHistory();
            }
        }
        calculate();
    }

    function renderHistory() {
        const hist = JSON.parse(localStorage.getItem('tsla_history') || "[]");
        const body = document.getElementById('history_body');
        
        body.innerHTML = hist.map(h => {
            const sd = parseFloat(h.sd);
            const tot = parseFloat(h.tot);
            const ratio = sd / tot;
            const currentPct = Math.round(ratio * 100);
            
            // Calculate specific target milestone for this entry
            let targetRatio = (currentPct + 0.5) / 100;
            if (ratio >= targetRatio) targetRatio = (currentPct + 1.5) / 100;
            
            const needed = ((targetRatio * tot - sd) / (1 - targetRatio)).toFixed(1);
            const targetLabel = Math.round(targetRatio * 100);

            return `
                <tr>
                    <td>${h.time.split(',')[0]}</td>
                    <td>${sd.toFixed(1)}</td>
                    <td>${tot.toFixed(1)}</td>
                    <td style="color:var(--red); font-weight:bold;">
                        ${Math.max(0, needed)} mi 
                        <span style="font-size:0.6rem; color:var(--dim);">to ${targetLabel}%</span>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function toggleTheme() {
        const next = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', next);
        localStorage.setItem('tsla_theme', next);
    }

    function exportData() {
        const data = { 
            sd: sdIn.value, tot: totIn.value, 
            key: localStorage.getItem('tsla_key') || localStorage.getItem('tsla_gemini_key'), 
            history: JSON.parse(localStorage.getItem('tsla_history') || "[]") 
        };
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
        a.download = `fsd_tracker_backup.json`;
        a.click();
    }

    function importData(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const d = JSON.parse(ev.target.result);
            localStorage.setItem('tsla_sd', d.sd || d.tesla_sd_miles || "");
            localStorage.setItem('tsla_tot', d.tot || d.tesla_total_miles || "");
            localStorage.setItem('tsla_key', d.key || d.tsla_gemini_key || "");
            localStorage.setItem('tsla_history', JSON.stringify(d.history || []));
            location.reload();
        };
        reader.readAsText(e.target.files[0]);
    }

    async function handleScan(event) {
        const file = event.target.files[0];
        const key = localStorage.getItem('tsla_key') || localStorage.getItem('tsla_gemini_key');
        if (!file || !key) return alert("Missing API Key in Settings!");
        
        document.getElementById('status').innerText = "Analyzing...";
        const reader = new FileReader();
        reader.onloadend = async () => {
            const b64 = reader.result.split(',')[1];
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${key}`;
                const resp = await fetch(url, { method: 'POST', body: JSON.stringify({ contents: [{ parts: [ { text: "Look at the Tesla screen. Return JSON only: {\"sd\": 0.0, \"total\": 0.0}" }, { inline_data: { mime_type: "image/jpeg", data: b64 } } ] }] }) });
                const d = await resp.json();
                const j = JSON.parse(d.candidates[0].content.parts[0].text.match(/\{.*\}/s)[0]);
                sdIn.value = j.sd; totIn.value = j.total;
                document.getElementById('status').innerText = "Sync Success!";
                saveAndCalc(true);
            } catch (err) { 
                document.getElementById('status').innerText = "Scan Failed."; 
                log(err.message); 
            }
        };
        reader.readAsDataURL(file);
    }

    function calculate() {
        const sd = parseFloat(sdIn.value) || 0, tot = parseFloat(totIn.value) || 0;
        if (tot <= 0) return;
        const ratio = sd/tot, currentPct = Math.round(ratio * 100);
        let target = (currentPct + 0.5) / 100;
        if (ratio >= target) target = (currentPct + 1.5) / 100;
        document.getElementById('disp_pct').innerText = currentPct + "%";
        document.getElementById('disp_next').innerText = Math.round(target * 100) + "%";
        document.getElementById('milestone_desc').innerText = `Miles to reach ${Math.round(target * 100)}%`;
        const x = ((target * tot - sd) / (1 - target)).toFixed(1);
        document.getElementById('result').innerText = Math.max(0, x);
    }
</script>
</body>
</html>
